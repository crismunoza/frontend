import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class RutService {
    constructor() {
        this._subject = new Subject();
    }
    clearInputService(event) {
        this._subject.next(event);
    }
    get events$() {
        return this._subject.asObservable();
    }
    rutFormat(value) {
        const rut = this.rutClean(value);
        if (rut.length <= 1) {
            return;
        }
        let result = `${rut.slice(-4, -1)}-${rut.substr(rut.length - 1)}`;
        for (let i = 4; i < rut.length; i += 3) {
            result = `${rut.slice(-3 - i, -i)}.${result}`;
        }
        return result;
    }
    rutClean(value) {
        return typeof value === 'string' ? value.replace(/[^0-9kK]+/g, '').toUpperCase() : '';
    }
    validaRUT(rut) {
        let valor = rut;
        valor = this.rutClean(valor);
        // Aislar Cuerpo y Dígito Verificador
        const cuerpo = valor.slice(0, -1);
        let dv = valor.slice(-1).toUpperCase();
        // Si no cumple con el mínimo ej. (n.nnn.nnn)
        if (cuerpo.length < 7 && cuerpo.length >= 0) {
            return true;
        }
        // Calcular Dígito Verificador
        let suma = 0;
        let multiplo = 2;
        // Para cada dígito del Cuerpo
        for (let i = 1; i <= cuerpo.length; i++) {
            // Obtener su Producto con el Múltiplo Correspondiente
            const index = multiplo * Number(valor.charAt(cuerpo.length - i));
            // Sumar al Contador General
            suma = suma + index;
            // Consolidar Múltiplo dentro del rango [2,7]
            if (multiplo < 7) {
                multiplo = multiplo + 1;
            }
            else {
                multiplo = 2;
            }
        }
        // Calcular Dígito Verificador en base al Módulo 11
        const dvEsperado = 11 - (suma % 11);
        // Casos Especiales (0 y K)
        dv = dv === 'K' ? '10' : dv;
        dv = dv === '0' ? '11' : dv;
        // Validar que el Cuerpo coincide con su Dígito Verificador
        if (dvEsperado.toString() !== dv && cuerpo.length >= 0) {
            return true;
        }
        else {
            return false;
        }
    }
    getRutChile(mode, rut) {
        if (!this.validaRUT(rut)) {
            switch (mode) {
                // el rut limpio 184215551
                case 0:
                    return this.rutClean(rut);
                // solo el cuerpo del rut  18421555
                case 1:
                    let valor = rut;
                    valor = this.rutClean(valor);
                    let cuerpo = valor.slice(0, -1);
                    return cuerpo;
                // rut formateado 18.421.555-1
                case 2:
                    return this.rutFormat(rut);
                // rut cuerpo - digitov : 18421555-1  
                case 3:
                    let r = rut;
                    r = this.rutClean(r);
                    const c = r.slice(0, -1);
                    let dv = r.slice(-1).toUpperCase();
                    return c + '-' + dv;
                case 4:
                    let ru = rut;
                    ru = this.rutClean(ru);
                    let div = ru.slice(-1).toUpperCase();
                    return div;
            }
        }
        else {
            return false;
        }
    }
    validaRutForm(control) {
        if (control.value == null || control.value === 'undefined' || control.value === "") {
            // TODO: RETORNA TRUE YA QUE LA IDEA ES USAR Validators.required
            return null;
        }
        else {
            let rut = control.value;
            let valor = (rut || '').replace(/[^0-9kK]+/g, '').toUpperCase();
            // Aislar Cuerpo y Dígito Verificador
            const cuerpo = valor.slice(0, -1);
            let dv = valor.slice(-1).toUpperCase();
            // Si no cumple con el mínimo ej. (n.nnn.nnn)
            if (cuerpo.length < 7 && cuerpo.length >= 0) {
                return {
                    rutnovalido: true
                };
            }
            // Calcular Dígito Verificador
            let suma = 0;
            let multiplo = 2;
            // Para cada dígito del Cuerpo
            for (let i = 1; i <= cuerpo.length; i++) {
                // Obtener su Producto con el Múltiplo Correspondiente
                const index = multiplo * Number(valor.charAt(cuerpo.length - i));
                // Sumar al Contador General
                suma = suma + index;
                // Consolidar Múltiplo dentro del rango [2,7]
                if (multiplo < 7) {
                    multiplo = multiplo + 1;
                }
                else {
                    multiplo = 2;
                }
            }
            // Calcular Dígito Verificador en base al Módulo 11
            const dvEsperado = 11 - (suma % 11);
            // Casos Especiales (0 y K)
            dv = dv === 'K' ? '10' : dv;
            dv = dv === '0' ? '11' : dv;
            // Validar que el Cuerpo coincide con su Dígito Verificador
            if (dvEsperado.toString() !== dv && cuerpo.length >= 0) {
                return {
                    rutnovalido: true
                };
            }
            else {
                return null;
            }
        }
    }
    getRutChileForm(mode, rut) {
        switch (mode) {
            case 0: // el rut limpio 184215551
                return this.rutClean(rut);
            case 1: // rut formateado 18.421.555-1
                return this.rutFormat(rut);
            case 2: // rut cuerpo - digitov : 18421555-1 
                let r = rut;
                r = this.rutClean(r);
                const c = r.slice(0, -1);
                let dv = r.slice(-1).toUpperCase();
                return c + '-' + dv;
        }
    }
    isRutEmpy(rut) {
        return rut === '' || rut === null || rut === undefined;
    }
}
RutService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: RutService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
RutService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: RutService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.11", ngImport: i0, type: RutService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnV0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9ydXQtY2hpbGVuby9zcmMvbGliL3J1dC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFLL0IsTUFBTSxPQUFPLFVBQVU7SUFHckI7UUFGUSxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztJQUV0QixDQUFDO0lBRWpCLGlCQUFpQixDQUFDLEtBQVU7UUFDMUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQWE7UUFDckIsTUFBTSxHQUFHLEdBQVcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxJQUFJLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQ25CLE9BQU87U0FDUjtRQUVELElBQUksTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ2xFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdEMsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFB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S0FBSSxFQUFFLElBQUksR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLEtBQUssU0FBUyxDQUFDO0lBQ3hELENBQUM7O3dHQXRNVSxVQUFVOzRHQUFWLFVBQVUsY0FGVCxNQUFNOzRGQUVQLFVBQVU7a0JBSHRCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBSdXRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBfc3ViamVjdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIGNsZWFySW5wdXRTZXJ2aWNlKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLl9zdWJqZWN0Lm5leHQoZXZlbnQpO1xuICB9XG5cbiAgZ2V0IGV2ZW50cyQgKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcnV0Rm9ybWF0KHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHJ1dDogc3RyaW5nID0gdGhpcy5ydXRDbGVhbih2YWx1ZSk7XG4gICAgaWYgKHJ1dC5sZW5ndGggPD0gMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiBcbiAgICBsZXQgcmVzdWx0ID0gYCR7cnV0LnNsaWNlKC00LCAtMSl9LSR7cnV0LnN1YnN0cihydXQubGVuZ3RoIC0gMSl9YDtcbiAgICBmb3IgKGxldCBpID0gNDsgaSA8IHJ1dC5sZW5ndGg7IGkgKz0gMykge1xuICAgICAgcmVzdWx0ID0gYCR7cnV0LnNsaWNlKC0zIC0gaSwgLWkpfS4ke3Jlc3VsdH1gO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBydXRDbGVhbih2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlLnJlcGxhY2UoL1teMC05a0tdKy9nLCAnJykudG9VcHBlckNhc2UoKSA6ICcnO1xuICB9XG4gIFxuICB2YWxpZGFSVVQocnV0OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBsZXQgdmFsb3I6IHN0cmluZyA9IHJ1dDtcbiAgICB2YWxvciA9IHRoaXMucnV0Q2xlYW4odmFsb3IpO1xuICBcbiAgICAvLyBBaXNsYXIgQ3VlcnBvIHkgRMOtZ2l0byBWZXJpZmljYWRvclxuICAgIGNvbnN0IGN1ZXJwbyA9IHZhbG9yLnNsaWNlKDAsIC0xKTtcbiAgICBsZXQgZHYgPSB2YWxvci5zbGljZSgtMSkudG9VcHBlckNhc2UoKTtcbiAgXG4gICAgLy8gU2kgbm8gY3VtcGxlIGNvbiBlbCBtw61uaW1vIGVqLiAobi5ubm4ubm5uKVxuICAgIGlmIChjdWVycG8ubGVuZ3RoIDwgNyAmJiBjdWVycG8ubGVuZ3RoID49IDApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgXG4gICAgLy8gQ2FsY3VsYXIgRMOtZ2l0byBWZXJpZmljYWRvclxuICAgIGxldCBzdW1hID0gMDtcbiAgICBsZXQgbXVsdGlwbG8gPSAyO1xuICBcbiAgICAvLyBQYXJhIGNhZGEgZMOtZ2l0byBkZWwgQ3VlcnBvXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gY3VlcnBvLmxlbmd0aDsgaSsrKSB7XG4gICAgICAvLyBPYnRlbmVyIHN1IFByb2R1Y3RvIGNvbiBlbCBNw7psdGlwbG8gQ29ycmVzcG9uZGllbnRlXG4gICAgICBjb25zdCBpbmRleCA9IG11bHRpcGxvICogTnVtYmVyKHZhbG9yLmNoYXJBdChjdWVycG8ubGVuZ3RoIC0gaSkpO1xuICBcbiAgICAgIC8vIFN1bWFyIGFsIENvbnRhZG9yIEdlbmVyYWxcbiAgICAgIHN1bWEgPSBzdW1hICsgaW5kZXg7XG4gIFxuICAgICAgLy8gQ29uc29saWRhciBNw7psdGlwbG8gZGVudHJvIGRlbCByYW5nbyBbMiw3XVxuICAgICAgaWYgKG11bHRpcGxvIDwgNykge1xuICAgICAgICBtdWx0aXBsbyA9IG11bHRpcGxvICsgMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG11bHRpcGxvID0gMjtcbiAgICAgIH1cbiAgICB9XG4gIFxuICAgIC8vIENhbGN1bGFyIETDrWdpdG8gVmVyaWZpY2Fkb3IgZW4gYmFzZSBhbCBNw7NkdWxvIDExXG4gICAgY29uc3QgZHZFc3BlcmFkbyA9IDExIC0gKHN1bWEgJSAxMSk7XG4gIFxuICAgIC8vIENhc29zIEVzcGVjaWFsZXMgKDAgeSBLKVxuICAgIGR2ID0gZHYgPT09ICdLJyA/ICcxMCcgOiBkdjtcbiAgICBkdiA9IGR2ID09PSAnMCcgPyAnMTEnIDogZHY7XG4gIFxuICAgIC8vIFZhbGlkYXIgcXVlIGVsIEN1ZXJwbyBjb2luY2lkZSBjb24gc3UgRMOtZ2l0byBWZXJpZmljYWRvclxuICAgIGlmIChkdkVzcGVyYWRvLnRvU3RyaW5nKCkgIT09IGR2ICYmIGN1ZXJwby5sZW5ndGggPj0gMCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgfVxuXG5cbiAgZ2V0UnV0Q2hpbGUobW9kZTogbnVtYmVyICxydXQ6IHN0cmluZyk6IHN0cmluZyB8IGJvb2xlYW4gfCB1bmRlZmluZWQge1xuXG4gICAgaWYoIXRoaXMudmFsaWRhUlVUKHJ1dCkpIHtcbiAgICAgIHN3aXRjaCAobW9kZSkge1xuICAgICAgICAvLyBlbCBydXQgbGltcGlvIDE4NDIxNTU1MVxuICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgcmV0dXJuIHRoaXMucnV0Q2xlYW4ocnV0KTtcbiAgICAgICAgLy8gc29sbyBlbCBjdWVycG8gZGVsIHJ1dCAgMTg0MjE1NTVcbiAgICAgICAgY2FzZSAxOlxuICAgICAgICAgIGxldCB2YWxvcjogc3RyaW5nID0gcnV0O1xuICAgICAgICAgIHZhbG9yID0gdGhpcy5ydXRDbGVhbih2YWxvcik7XG4gICAgICAgICAgbGV0IGN1ZXJwbyA9IHZhbG9yLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICByZXR1cm4gY3VlcnBvO1xuICAgICAgICAvLyBydXQgZm9ybWF0ZWFkbyAxOC40MjEuNTU1LTFcbiAgICAgICAgY2FzZSAyOlxuICAgICAgICAgIHJldHVybiB0aGlzLnJ1dEZvcm1hdChydXQpOyAgICAgICAgICBcbiAgICAgICAgLy8gcnV0IGN1ZXJwbyAtIGRpZ2l0b3YgOiAxODQyMTU1NS0xICBcbiAgICAgICAgY2FzZSAzOlxuICAgICAgICAgICAgbGV0IHI6IHN0cmluZyA9IHJ1dDtcbiAgICAgICAgICAgIHIgPSB0aGlzLnJ1dENsZWFuKHIpO1xuICAgICAgICAgICAgY29uc3QgYyA9IHIuc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgbGV0IGR2ID0gci5zbGljZSgtMSkudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIHJldHVybiBjICsgJy0nKyBkdjtcbiAgICAgICAgY2FzZSA0OlxuICAgICAgICAgIGxldCBydTogc3RyaW5nID0gcnV0O1xuICAgICAgICAgIHJ1ID0gdGhpcy5ydXRDbGVhbihydSk7XG4gICAgICAgICAgbGV0IGRpdiA9IHJ1LnNsaWNlKC0xKS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgIHJldHVybiBkaXY7IFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgICAgXG4gIH1cblxuXG4gIHZhbGlkYVJ1dEZvcm0oY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogeyBba2V5OiBzdHJpbmddOiBib29sZWFuIH0gfCBudWxsIHtcbiAgICBcbiAgICBpZiAoY29udHJvbC52YWx1ZSA9PSBudWxsIHx8IGNvbnRyb2wudmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IGNvbnRyb2wudmFsdWUgPT09IFwiXCIgKSB7XG4gICAgICAvLyBUT0RPOiBSRVRPUk5BIFRSVUUgWUEgUVVFIExBIElERUEgRVMgVVNBUiBWYWxpZGF0b3JzLnJlcXVpcmVkXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGVsc2Uge1xuXG4gICAgICBsZXQgcnV0OiBzdHJpbmcgPSBjb250cm9sLnZhbHVlO1xuICAgIFxuICAgICAgbGV0IHZhbG9yOiBzdHJpbmcgPSAocnV0IHx8ICcnKS5yZXBsYWNlKC9bXjAtOWtLXSsvZywgJycpLnRvVXBwZXJDYXNlKCk7XG4gICAgIFxuICAgICAgLy8gQWlzbGFyIEN1ZXJwbyB5IETDrWdpdG8gVmVyaWZpY2Fkb3JcbiAgICAgIGNvbnN0IGN1ZXJwbyA9IHZhbG9yLnNsaWNlKDAsIC0xKTtcbiAgICAgIGxldCBkdiA9IHZhbG9yLnNsaWNlKC0xKS50b1VwcGVyQ2FzZSgpO1xuICAgIFxuICAgICAgLy8gU2kgbm8gY3VtcGxlIGNvbiBlbCBtw61uaW1vIGVqLiAobi5ubm4ubm5uKVxuICAgICAgaWYgKGN1ZXJwby5sZW5ndGggPCA3ICYmIGN1ZXJwby5sZW5ndGggPj0gMCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHJ1dG5vdmFsaWRvOiB0cnVlXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgXG4gICAgICAvLyBDYWxjdWxhciBEw61naXRvIFZlcmlmaWNhZG9yXG4gICAgICBsZXQgc3VtYSA9IDA7XG4gICAgICBsZXQgbXVsdGlwbG8gPSAyO1xuICAgIFxuICAgICAgLy8gUGFyYSBjYWRhIGTDrWdpdG8gZGVsIEN1ZXJwb1xuICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gY3VlcnBvLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIC8vIE9idGVuZXIgc3UgUHJvZHVjdG8gY29uIGVsIE3Dumx0aXBsbyBDb3JyZXNwb25kaWVudGVcbiAgICAgICAgY29uc3QgaW5kZXggPSBtdWx0aXBsbyAqIE51bWJlcih2YWxvci5jaGFyQXQoY3VlcnBvLmxlbmd0aCAtIGkpKTtcbiAgICBcbiAgICAgICAgLy8gU3VtYXIgYWwgQ29udGFkb3IgR2VuZXJhbFxuICAgICAgICBzdW1hID0gc3VtYSArIGluZGV4O1xuICAgIFxuICAgICAgICAvLyBDb25zb2xpZGFyIE3Dumx0aXBsbyBkZW50cm8gZGVsIHJhbmdvIFsyLDddXG4gICAgICAgIGlmIChtdWx0aXBsbyA8IDcpIHtcbiAgICAgICAgICBtdWx0aXBsbyA9IG11bHRpcGxvICsgMTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtdWx0aXBsbyA9IDI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICBcbiAgICAgIC8vIENhbGN1bGFyIETDrWdpdG8gVmVyaWZpY2Fkb3IgZW4gYmFzZSBhbCBNw7NkdWxvIDExXG4gICAgICBjb25zdCBkdkVzcGVyYWRvID0gMTEgLSAoc3VtYSAlIDExKTtcbiAgICBcbiAgICAgIC8vIENhc29zIEVzcGVjaWFsZXMgKDAgeSBLKVxuICAgICAgZHYgPSBkdiA9PT0gJ0snID8gJzEwJyA6IGR2O1xuICAgICAgZHYgPSBkdiA9PT0gJzAnID8gJzExJyA6IGR2O1xuICAgIFxuICAgICAgLy8gVmFsaWRhciBxdWUgZWwgQ3VlcnBvIGNvaW5jaWRlIGNvbiBzdSBEw61naXRvIFZlcmlmaWNhZG9yXG4gICAgICBpZiAoZHZFc3BlcmFkby50b1N0cmluZygpICE9PSBkdiAmJiBjdWVycG8ubGVuZ3RoID49IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBydXRub3ZhbGlkbzogdHJ1ZVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfVxuXG4gIH1cblxuXG4gIGdldFJ1dENoaWxlRm9ybShtb2RlOiBudW1iZXIgLHJ1dDogc3RyaW5nKTogc3RyaW5nIHwgYm9vbGVhbiB8IHVuZGVmaW5lZCB7XG5cbiAgICAgIHN3aXRjaCAobW9kZSkge1xuICAgICAgICBjYXNlIDA6IC8vIGVsIHJ1dCBsaW1waW8gMTg0MjE1NTUxXG4gICAgICAgICAgcmV0dXJuIHRoaXMucnV0Q2xlYW4ocnV0KTtcbiAgICAgICAgY2FzZSAxOiAvLyBydXQgZm9ybWF0ZWFkbyAxOC40MjEuNTU1LTFcbiAgICAgICAgICByZXR1cm4gdGhpcy5ydXRGb3JtYXQocnV0KTsgICAgICAgICAgXG4gICAgICAgIGNhc2UgMjogLy8gcnV0IGN1ZXJwbyAtIGRpZ2l0b3YgOiAxODQyMTU1NS0xIFxuICAgICAgICAgICAgbGV0IHI6IHN0cmluZyA9IHJ1dDtcbiAgICAgICAgICAgIHIgPSB0aGlzLnJ1dENsZWFuKHIpO1xuICAgICAgICAgICAgY29uc3QgYyA9IHIuc2xpY2UoMCwgLTEpO1xuICAgICAgICAgICAgbGV0IGR2ID0gci5zbGljZSgtMSkudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIHJldHVybiBjICsgJy0nKyBkdjtcbiAgICAgIH1cbiAgICAgIFxuICB9XG5cbiAgaXNSdXRFbXB5KHJ1dDogc3RyaW5nKSA6IGJvb2xlYW4ge1xuICAgIHJldHVybiBydXQgPT09JycgfHwgcnV0ID09PSBudWxsIHx8IHJ1dCA9PT0gdW5kZWZpbmVkO1xuICB9XG5cbn1cbiJdfQ==